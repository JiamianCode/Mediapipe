<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>D3 Collision Detection</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
<script>
    (function() {
        const width = 800; // 设定画布宽度
        const height = width; // 画布高度与宽度相同
        const color = d3.scaleOrdinal(d3.schemeTableau10); // 颜色比例尺
        const canvas = document.createElement('canvas'); // 创建canvas元素
        document.body.appendChild(canvas); // 将canvas添加到body中
        canvas.width = width;
        canvas.height = height;
        const context = canvas.getContext('2d'); // 获取2D上下文

        const data = Array.from({length: 200}, (_, i) => ({
            r: d3.randomUniform(width / 200, width / 50)(), // 随机半径
            group: i % 4 + 1 // 分组
        }));

        const nodes = data.map(Object.create); // 创建节点数组的浅副本

        const simulation = d3.forceSimulation(nodes)
            .alphaTarget(0.3) // 设置温度，让布局更活跃
            .velocityDecay(0.1) // 设置速度衰减
            .force("x", d3.forceX().strength(0.01))
            .force("y", d3.forceY().strength(0.01))
            .force("collide", d3.forceCollide().radius(d => d.r + 1).iterations(3))
            .force("charge", d3.forceManyBody().strength((d, i) => i ? 0 : -width * 2 / 3))
            .on("tick", ticked); // 每次迭代调用

        canvas.addEventListener("pointermove", pointermoved);

        function pointermoved(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left - width / 2;
            const y = event.clientY - rect.top - height / 2;
            nodes[0].fx = x;
            nodes[0].fy = y;
        }

        function ticked() {
            context.clearRect(0, 0, width, height);
            context.save();
            context.translate(width / 2, height / 2);
            for (const d of nodes) {
                context.beginPath();
                context.moveTo(d.x + d.r, d.y);
                context.arc(d.x, d.y, d.r, 0, 2 * Math.PI);
                context.fillStyle = color(d.group);
                context.fill();
            }
            context.restore();
        }
    })();
</script>
</body>
</html>
